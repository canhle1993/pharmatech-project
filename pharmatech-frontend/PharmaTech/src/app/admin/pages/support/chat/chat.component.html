<div class="admin-chat">
  <!-- Sidebar: danh sách user -->
  <aside class="sidebar">
    <h3>Người dùng</h3>

    <div class="search">
      <input type="text" [(ngModel)]="q" placeholder="Tìm tên, username, email, id..." (input)="onSearch()" />
    </div>

    <!-- DANH SÁCH USER CÓ THANH CUỘN -->
    <ul
      class="user-list"
      style="overflow-y: auto; height: calc(100vh - 220px); padding-right: 4px;"
    >
      @for (u of filtered; track displayId(u)) {
      <li
        (click)="openThread(u)"
        [class.active]="currentUserId === displayId(u)"
        [class.unread]="isUnread(displayId(u))"
        class="user-item"
      >
        <div class="line1">
          <span class="name">{{ displayName(u) }}</span>
          <span class="line1-right">
            <span class="badge" [class.on]="u?.is_active">●</span>
            @if (isUnread(displayId(u))) {
              <span class="unread-dot"></span>
            }
          </span>
        </div>
        <div class="line2 id">{{ displayId(u) }}</div>
      </li>
      }
      @if (!filtered?.length) {
      <li class="empty">Không có người dùng</li>
      }
    </ul>
  </aside>

  <!-- Khung chat -->
  <section class="chat-panel">
    <header class="chat-header">
      @if (currentUser) {
      Đang chat với: <strong>{{ displayName(currentUser) }}</strong>
      <span class="id">({{ currentUserId }})</span>
      } @else {
      <ng-container>Chọn một user ở danh sách bên trái để bắt đầu</ng-container>
      }
    </header>

    <!-- KHUNG CHAT CÓ THANH CUỘN -->
    <div
      class="chat-box"
      #chatBoxRef
      style="overflow-y: auto; height: calc(100vh - 260px); padding-right: 4px;"
    >
      @for (m of history; track trackKey(m, $index)) {
      <div [class.msg]="true" [class.admin]="isAdminMsg(m)" [class.user]="!isAdminMsg(m)">
        <div class="bubble">
          <span class="from">{{ isAdminMsg(m) ? 'Admin' : '' }}</span>
          <span class="text">{{ m.text }}</span>
          @if (m.createdAt) {
          <span class="time">{{ m.createdAt | date:'short' }}</span>
          }
        </div>
      </div>
      }

      @if (currentUserId && !history?.length) {
      <div class="empty">Chưa có tin nhắn nào. Hãy gửi lời chào trước nhé.</div>
      }
    </div>

    <form class="chat-input" (ngSubmit)="send()">
      <input
        type="text"
        [(ngModel)]="msg"
        name="message"
        placeholder="Nhập tin nhắn..."
        autocomplete="off"
        [disabled]="!currentUserId"
        required
      />
      <button type="submit" pButton [disabled]="!currentUserId || !msg?.trim()">Gửi</button>
    </form>
  </section>
</div>
